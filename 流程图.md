# OpenWork 处理流程图

## 流程图模块

### 模块关系图

```mermaid
flowchart TD
    AppStart["应用启动流程"] --> ModeSelection["模式选择流程"]
    ModeSelection -->|"Host 模式"| WorkspaceMgmt["工作区管理流程"]
    ModeSelection -->|"Client 模式"| ClientConnect["客户端连接流程"]
    
    WorkspaceMgmt --> SessionMgmt["会话管理流程"]
    ClientConnect --> SessionMgmt
    
    SessionMgmt --> TaskExecution["任务执行流程"]
    TaskExecution --> PermissionMgmt["权限管理流程"]
    TaskExecution --> ExtensionMgmt["扩展管理流程"]
    
    WorkspaceMgmt --> TemplateMgmt["模板管理流程"]
    TemplateMgmt --> TaskExecution
```

**模块说明**：
- **应用启动流程**：初始化应用，加载配置和状态
- **模式选择流程**：选择 Host 模式（本地运行）或 Client 模式（连接远程服务器）
- **工作区管理流程**：创建、选择、激活工作区，管理授权目录
- **客户端连接流程**：连接到远程 OpenCode 服务器
- **会话管理流程**：创建、选择、管理会话
- **任务执行流程**：执行 AI 任务，处理提示词、计划、执行和结果
- **权限管理流程**：处理权限请求，管理授权范围
- **扩展管理流程**：管理 Skills、Plugins、MCP 等扩展
- **模板管理流程**：创建、保存、运行模板

### 1. 应用启动流程

**职责**：初始化应用，加载配置和状态

**输入**：应用启动  
**输出**：进入模式选择或直接进入主界面

```mermaid
flowchart TD
    Start(["应用启动"]) --> LoadConfig["加载配置文件"]
    LoadConfig --> CheckModePref{"是否有模式偏好"}
    
    CheckModePref -->|有| LoadWorkspace["加载工作区列表"]
    CheckModePref -->|无| ShowModeSelection["显示模式选择界面"]
    
    LoadWorkspace --> CheckEngine{"检查 OpenCode 引擎"}
    CheckEngine -->|已运行| AttachEngine["附加到现有引擎"]
    CheckEngine -->|未运行| ShowModeSelection
    
    AttachEngine --> ConnectServer["连接到服务器"]
    ConnectServer --> LoadSessions["加载会话列表"]
    LoadSessions --> ShowDashboard["显示主界面"]
    
    ShowModeSelection --> EndNode["等待用户选择"]
```

### 2. 模式选择流程

**职责**：选择运行模式（Host 或 Client）

**输入**：用户选择模式  
**输出**：进入相应模式的初始化流程

```mermaid
flowchart TD
    StartNode["模式选择界面"] --> UserChoice{"用户选择"}
    
    UserChoice -->|Host 模式| HostInit["Host 模式初始化"]
    UserChoice -->|Client 模式| ClientInit["Client 模式初始化"]
    
    HostInit --> CheckEngine["检查 OpenCode CLI"]
    CheckEngine -->|未安装| ShowInstall["显示安装提示"]
    CheckEngine -->|已安装| WorkspaceSelection["工作区选择"]
    
    ClientInit --> InputUrl["输入服务器 URL"]
    InputUrl --> ConnectClient["连接客户端"]
    
    ShowInstall --> EndNode["结束"]
    WorkspaceSelection --> EndNode
    ConnectClient --> EndNode
```

### 3. 工作区管理流程

**职责**：管理工作区（创建、选择、激活）

**输入**：工作区操作请求  
**输出**：激活的工作区

```mermaid
flowchart TD
    StartNode["工作区管理"] --> Operation{"操作类型"}
    
    Operation -->|创建| CreateWorkspace["创建工作区"]
    Operation -->|选择| SelectWorkspace["选择工作区"]
    Operation -->|激活| ActivateWorkspace["激活工作区"]
    
    CreateWorkspace --> PickFolder["选择文件夹"]
    PickFolder --> ChoosePreset["选择预设模板"]
    ChoosePreset --> InitWorkspace["初始化工作区文件"]
    InitWorkspace --> SaveWorkspace["保存工作区配置"]
    SaveWorkspace --> ActivateWorkspace
    
    SelectWorkspace --> ActivateWorkspace
    
    ActivateWorkspace --> LoadConfig["加载工作区配置"]
    LoadConfig --> LoadAuthorizedDirs["加载授权目录"]
    LoadAuthorizedDirs --> LoadTemplates["加载模板列表"]
    LoadTemplates --> StartEngine["启动 OpenCode 引擎"]
    
    StartEngine --> ConnectEngine["连接到引擎"]
    ConnectEngine --> EndNode["工作区激活完成"]
```

### 4. 会话管理流程

**职责**：创建、选择、管理会话

**输入**：会话操作请求  
**输出**：选中的会话

```mermaid
flowchart TD
    StartNode["会话管理"] --> Operation{"操作类型"}
    
    Operation -->|创建| CreateSession["创建新会话"]
    Operation -->|选择| SelectSession["选择现有会话"]
    Operation -->|列表| ListSessions["列出所有会话"]
    
    CreateSession --> GetWorkspace["获取当前工作区"]
    GetWorkspace --> CallCreateAPI["调用 session.create API"]
    CallCreateAPI --> LoadSessionData["加载会话数据"]
    LoadSessionData --> SelectSession
    
    SelectSession --> LoadMessages["加载消息历史"]
    LoadMessages --> LoadTodos["加载待办事项"]
    LoadTodos --> LoadPermissions["加载权限请求"]
    LoadPermissions --> SubscribeEvents["订阅事件流"]
    
    ListSessions --> FilterByWorkspace["按工作区过滤"]
    FilterByWorkspace --> DisplaySessions["显示会话列表"]
    
    SubscribeEvents --> EndNode["会话就绪"]
    DisplaySessions --> EndNode
```

### 5. 任务执行流程

**职责**：执行 AI 任务，处理提示词、计划、执行和结果

**输入**：用户提示词  
**输出**：任务执行结果

```mermaid
flowchart TD
    StartNode["任务执行"] --> GetPrompt["获取用户提示词"]
    GetPrompt --> ValidateSession{"会话是否有效"}
    
    ValidateSession -->|否| CreateSession["创建新会话"]
    ValidateSession -->|是| SendPrompt["发送提示词"]
    
    CreateSession --> SendPrompt
    
    SendPrompt --> WaitPlan["等待计划生成"]
    WaitPlan --> ReceivePlan["接收计划（Todos）"]
    ReceivePlan --> ShowPlan["显示计划给用户"]
    
    ShowPlan --> UserApprove{"用户批准"}
    UserApprove -->|否| CancelTask["取消任务"]
    UserApprove -->|是| ExecutePlan["执行计划"]
    
    ExecutePlan --> ProcessStep["处理每个步骤"]
    ProcessStep --> CheckPermission{"需要权限"}
    
    CheckPermission -->|是| RequestPermission["请求权限"]
    CheckPermission -->|否| ExecuteTool["执行工具调用"]
    
    RequestPermission --> UserResponse{"用户响应"}
    UserResponse -->|允许| ExecuteTool
    UserResponse -->|拒绝| SkipStep["跳过步骤"]
    
    ExecuteTool --> UpdateStatus["更新步骤状态"]
    SkipStep --> UpdateStatus
    UpdateStatus --> MoreSteps{"还有步骤"}
    
    MoreSteps -->|是| ProcessStep
    MoreSteps -->|否| TaskComplete["任务完成"]
    
    CancelTask --> EndNode["结束"]
    TaskComplete --> ShowResults["显示结果"]
    ShowResults --> SaveArtifacts["保存产物"]
    SaveArtifacts --> EndNode
```

### 6. 权限管理流程

**职责**：处理权限请求，管理授权范围

**输入**：权限请求  
**输出**：权限决策

```mermaid
flowchart TD
    StartNode["权限管理"] --> ReceiveRequest["接收权限请求"]
    ReceiveRequest --> ParseRequest["解析请求内容"]
    
    ParseRequest --> CheckScope["检查请求范围"]
    CheckScope --> CheckAuthorized{"是否已授权"}
    
    CheckAuthorized -->|是| AutoAllow["自动允许"]
    CheckAuthorized -->|否| ShowPrompt["显示权限提示"]
    
    ShowPrompt --> UserChoice{"用户选择"}
    
    UserChoice -->|允许一次| AllowOnce["允许一次"]
    UserChoice -->|允许会话| AllowSession["允许会话"]
    UserChoice -->|始终允许| AllowAlways["始终允许"]
    UserChoice -->|拒绝| DenyRequest["拒绝请求"]
    
    AutoAllow --> SendResponse["发送响应"]
    AllowOnce --> SendResponse
    AllowSession --> SaveSessionAuth["保存会话授权"]
    SaveSessionAuth --> SendResponse
    AllowAlways --> SavePersistentAuth["保存持久授权"]
    SavePersistentAuth --> SendResponse
    DenyRequest --> SendResponse
    
    SendResponse --> EndNode["结束"]
```

### 7. 扩展管理流程

**职责**：管理 Skills、Plugins、MCP 等扩展

**输入**：扩展操作请求  
**输出**：扩展状态更新

```mermaid
flowchart TD
    StartNode["扩展管理"] --> ExtensionType{"扩展类型"}
    
    ExtensionType -->|Skills| ManageSkills["管理 Skills"]
    ExtensionType -->|Plugins| ManagePlugins["管理 Plugins"]
    ExtensionType -->|MCP| ManageMCP["管理 MCP"]
    
    ManageSkills --> SkillOperation{"操作类型"}
    SkillOperation -->|安装| InstallSkill["安装 Skill"]
    SkillOperation -->|卸载| UninstallSkill["卸载 Skill"]
    SkillOperation -->|列表| ListSkills["列出 Skills"]
    
    InstallSkill --> GetSource["获取来源"]
    GetSource -->|OpenPackage| InstallFromOpkg["从 OpenPackage 安装"]
    GetSource -->|本地| ImportLocalSkill["导入本地 Skill"]
    
    InstallFromOpkg --> DownloadSkill["下载 Skill"]
    DownloadSkill --> ExtractSkill["解压到 .opencode/skill"]
    ExtractSkill --> ReloadEngine["重新加载引擎"]
    
    ImportLocalSkill --> CopyToSkillDir["复制到 .opencode/skill"]
    CopyToSkillDir --> ReloadEngine
    
    ManagePlugins --> PluginOperation{"操作类型"}
    PluginOperation -->|添加| AddPlugin["添加 Plugin"]
    PluginOperation -->|移除| RemovePlugin["移除 Plugin"]
    PluginOperation -->|列表| ListPlugins["列出 Plugins"]
    
    AddPlugin --> UpdateOpencodeJson["更新 opencode.json"]
    UpdateOpencodeJson --> ReloadEngine
    
    ManageMCP --> McpOperation{"操作类型"}
    McpOperation -->|连接| ConnectMCP["连接 MCP 服务器"]
    McpOperation -->|断开| DisconnectMCP["断开 MCP 服务器"]
    McpOperation -->|列表| ListMCP["列出 MCP 服务器"]
    
    ConnectMCP --> AddMcpConfig["添加 MCP 配置"]
    AddMcpConfig --> ReloadEngine
    
    ReloadEngine --> EndNode["扩展管理完成"]
    ListSkills --> EndNode
    ListPlugins --> EndNode
    ListMCP --> EndNode
    UninstallSkill --> EndNode
    RemovePlugin --> EndNode
    DisconnectMCP --> EndNode
```

### 8. 模板管理流程

**职责**：创建、保存、运行模板

**输入**：模板操作请求  
**输出**：模板状态更新

```mermaid
flowchart TD
    StartNode["模板管理"] --> TemplateOperation{"操作类型"}
    
    TemplateOperation -->|创建| CreateTemplate["创建模板"]
    TemplateOperation -->|运行| RunTemplate["运行模板"]
    TemplateOperation -->|删除| DeleteTemplate["删除模板"]
    TemplateOperation -->|列表| ListTemplates["列出模板"]
    
    CreateTemplate --> GetSessionData["获取会话数据"]
    GetSessionData --> ExtractPrompt["提取提示词"]
    ExtractPrompt --> InputMetadata["输入元数据"]
    InputMetadata -->|标题| SetTitle["设置标题"]
    InputMetadata -->|描述| SetDescription["设置描述"]
    InputMetadata -->|范围| SetScope["设置范围"]
    
    SetTitle --> SaveTemplate["保存模板"]
    SetDescription --> SaveTemplate
    SetScope --> SaveTemplate
    
    SaveTemplate -->|工作区| SaveToWorkspace["保存到 .openwork/templates"]
    SaveTemplate -->|全局| SaveToGlobal["保存到全局位置"]
    
    RunTemplate --> LoadTemplate["加载模板"]
    LoadTemplate --> CreateSession["创建新会话"]
    CreateSession --> SendPrompt["发送模板提示词"]
    SendPrompt --> ExecuteTask["执行任务"]
    
    DeleteTemplate --> ConfirmDelete["确认删除"]
    ConfirmDelete --> RemoveFile["删除模板文件"]
    
    SaveToWorkspace --> EndNode["模板保存完成"]
    SaveToGlobal --> EndNode
    ExecuteTask --> EndNode
    RemoveFile --> EndNode
    ListTemplates --> EndNode
```

## 核心设计逻辑

### 1. 工作区管理机制
- **工作区即文件夹**：每个工作区对应一个文件夹路径
- **配置文件**：工作区配置保存在 `.openwork/openwork.json`
- **授权目录**：每个工作区维护授权目录列表，限制访问范围
- **预设模板**：支持 starter、custom 等预设模板

### 2. 会话管理机制
- **会话即任务**：每个会话对应一个 AI 任务执行上下文
- **会话隔离**：不同会话之间的状态和权限相互独立
- **会话持久化**：会话数据保存在 OpenCode 服务器端
- **事件流订阅**：通过 SSE 实时接收会话更新

### 3. 任务执行机制
- **提示词驱动**：用户输入提示词，AI 生成执行计划
- **计划预览**：执行前显示计划（Todos），用户可批准或取消
- **步骤执行**：按计划逐步执行，每个步骤可能涉及工具调用
- **权限检查**：每个步骤执行前检查所需权限
- **实时更新**：通过事件流实时更新执行状态和结果

### 4. 权限管理机制
- **最小权限原则**：默认拒绝，需要明确授权
- **权限级别**：
  - **允许一次**：仅当前操作有效
  - **允许会话**：当前会话内有效
  - **始终允许**：持久授权，跨会话有效
- **权限范围**：基于授权目录列表，限制文件系统访问
- **权限审计**：记录所有权限决策，便于审计

### 5. 扩展管理机制
- **Skills**：存储在 `.opencode/skill` 目录，通过 OpenPackage 安装
- **Plugins**：配置在 `opencode.json` 的 `plugin` 字段
- **MCP**：配置在 `opencode.json` 的 `mcp` 字段
- **热重载**：扩展变更后需要重新加载引擎才能生效

### 6. 模板管理机制
- **模板格式**：支持 Markdown frontmatter 或 JSON 格式
- **模板范围**：
  - **工作区模板**：保存在 `.openwork/templates`，仅当前工作区可用
  - **全局模板**：保存在全局位置，所有工作区可用
- **模板内容**：包含标题、描述、提示词等元数据
- **模板运行**：运行模板时创建新会话并发送模板提示词

## 关键代码位置（Python 实现）

### 应用启动和模式选择
- **应用入口**: `src/main.py` - `main()` 函数
- **模式选择**: `src/app.py` - `App.select_mode()` 方法
- **配置加载**: `src/config.py` - `Config.load()` 方法

### 工作区管理
- **工作区存储**: `src/workspace/store.py` - `WorkspaceStore` 类
- **工作区创建**: `src/workspace/manager.py` - `WorkspaceManager.create()` 方法
- **工作区激活**: `src/workspace/manager.py` - `WorkspaceManager.activate()` 方法
- **授权目录管理**: `src/workspace/manager.py` - `WorkspaceManager.manage_authorized_dirs()` 方法

### 引擎管理
- **引擎检查**: `src/engine/doctor.py` - `EngineDoctor.check()` 方法
- **引擎启动**: `src/engine/manager.py` - `EngineManager.start()` 方法
- **引擎停止**: `src/engine/manager.py` - `EngineManager.stop()` 方法
- **引擎信息**: `src/engine/manager.py` - `EngineManager.info()` 方法

### 客户端连接
- **客户端创建**: `src/client/opencode.py` - `OpenCodeClient.create()` 方法
- **健康检查**: `src/client/opencode.py` - `OpenCodeClient.health()` 方法
- **连接管理**: `src/client/manager.py` - `ClientManager.connect()` 方法

### 会话管理
- **会话创建**: `src/session/manager.py` - `SessionManager.create()` 方法
- **会话选择**: `src/session/manager.py` - `SessionManager.select()` 方法
- **会话列表**: `src/session/manager.py` - `SessionManager.list()` 方法
- **消息加载**: `src/session/manager.py` - `SessionManager.load_messages()` 方法
- **事件订阅**: `src/session/events.py` - `EventSubscriber.subscribe()` 方法

### 任务执行
- **提示词发送**: `src/session/manager.py` - `SessionManager.send_prompt()` 方法
- **计划处理**: `src/task/planner.py` - `TaskPlanner.process_plan()` 方法
- **步骤执行**: `src/task/executor.py` - `TaskExecutor.execute_step()` 方法
- **结果处理**: `src/task/executor.py` - `TaskExecutor.process_result()` 方法

### 权限管理
- **权限请求处理**: `src/permission/manager.py` - `PermissionManager.handle_request()` 方法
- **权限决策**: `src/permission/manager.py` - `PermissionManager.decide()` 方法
- **权限存储**: `src/permission/store.py` - `PermissionStore` 类
- **权限响应**: `src/permission/manager.py` - `PermissionManager.respond()` 方法

### 扩展管理
- **Skills 管理**: `src/extensions/skills.py` - `SkillsManager` 类
  - `install_from_opkg()`: 从 OpenPackage 安装
  - `import_local()`: 导入本地 Skill
  - `list()`: 列出已安装的 Skills
- **Plugins 管理**: `src/extensions/plugins.py` - `PluginsManager` 类
  - `add()`: 添加 Plugin
  - `remove()`: 移除 Plugin
  - `list()`: 列出已配置的 Plugins
- **MCP 管理**: `src/extensions/mcp.py` - `McpManager` 类
  - `connect()`: 连接 MCP 服务器
  - `disconnect()`: 断开 MCP 服务器
  - `list()`: 列出已配置的 MCP 服务器

### 模板管理
- **模板创建**: `src/templates/manager.py` - `TemplateManager.create()` 方法
- **模板保存**: `src/templates/manager.py` - `TemplateManager.save()` 方法
- **模板加载**: `src/templates/manager.py` - `TemplateManager.load()` 方法
- **模板运行**: `src/templates/manager.py` - `TemplateManager.run()` 方法
- **模板列表**: `src/templates/manager.py` - `TemplateManager.list()` 方法

### 工具函数
- **配置读写**: `src/utils/config.py` - 配置文件读写工具
- **文件操作**: `src/utils/files.py` - 文件系统操作工具
- **路径处理**: `src/utils/paths.py` - 路径处理工具（使用 pathlib）
- **异步工具**: `src/utils/async.py` - 异步操作工具

## 数据流

### 工作区数据流
```
用户选择文件夹 → 创建工作区 → 初始化配置文件 → 保存工作区状态 → 激活工作区 → 加载配置 → 启动引擎
```

### 会话数据流
```
创建会话 → 发送提示词 → 接收计划 → 用户批准 → 执行步骤 → 接收更新 → 显示结果 → 保存产物
```

### 权限数据流
```
工具调用需要权限 → 检查授权状态 → 未授权则请求 → 用户决策 → 保存决策 → 发送响应 → 继续执行
```

### 扩展数据流
```
安装扩展 → 更新配置 → 重新加载引擎 → 扩展生效 → 工具可用
```

## 状态管理

### 应用状态
- **当前模式**：Host 或 Client
- **当前工作区**：激活的工作区 ID
- **当前会话**：选中的会话 ID
- **引擎状态**：运行中、已停止、错误

### 工作区状态
- **工作区列表**：所有已创建的工作区
- **授权目录**：当前工作区的授权目录列表
- **模板列表**：当前工作区的模板列表

### 会话状态
- **会话列表**：当前工作区的所有会话
- **消息历史**：当前会话的消息列表
- **待办事项**：当前会话的计划（Todos）
- **权限请求**：当前会话的待处理权限请求

### 扩展状态
- **Skills 列表**：已安装的 Skills
- **Plugins 列表**：已配置的 Plugins
- **MCP 列表**：已配置的 MCP 服务器
